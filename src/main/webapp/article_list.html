<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Cache-Control" content="no-siteapp" />
 <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="css/style.css"/>       
        <link href="assets/css/codemirror.css" rel="stylesheet">
        <link rel="stylesheet" href="assets/css/ace.min.css" />
        <link rel="stylesheet" href="font/css/font-awesome.min.css" />
        <!--[if lte IE 8]>
		  <link rel="stylesheet" href="assets/css/ace-ie.min.css" />
		<![endif]-->
		<script src="js/jquery-1.9.1.min.js"></script>
        <script src="assets/js/bootstrap.min.js"></script>
		<script src="assets/js/typeahead-bs2.min.js"></script>  
        <script src="js/lrtk.js" type="text/javascript" ></script>	         	
		<script src="assets/js/jquery.dataTables.min.js"></script>
		<script src="assets/js/jquery.dataTables.bootstrap.js"></script>
        <script src="assets/layer/layer.js" type="text/javascript" ></script>          
        <script src="assets/laydate/laydate.js" type="text/javascript"></script>
        <script src="js/H-ui.js" type="text/javascript"></script>
        <script src="js/displayPart.js" type="text/javascript"></script>
<title>文章管理</title>
</head>

<body>
<div class="clearfix">
 <div class="article_style" id="article_style">
          <div id="scrollsidebar" class="left_Treeview">
    <div class="show_btn" id="rightArrow"><span></span></div>
    <div class="widget-box side_content" >
    <div class="side_title"><a title="隐藏" class="close_btn"><span></span></a></div>
     <div class="side_list">
      <div class="widget-header header-color-green2">
          <h4 class="lighter smaller">所属文章类</h4>
      </div>
      <div class="widget-body">
         <ul class="b_P_Sort_list" id="labelList">
             <li><i class="orange  fa fa-list "></i><a href="#" onclick="initPage(1)">全部</a></li>
             <!--<li><i class="fa fa-newspaper-o pink "></i> <a href="#">帮助中心(5)</a></li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">常见问题(3)</a> </li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">客服服务(3)</a></li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">购物指南(3)</a></li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">配送方式(33)</a></li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">支付方式(13)</a></li>-->
             <!--<li> <i class="fa fa-newspaper-o pink "></i> <a href="#">特色服务(23)</a></li>-->
             <!--<li><i class="fa fa-newspaper-o pink "></i> <a href="#">售后服务(6)</a></li>-->
         </ul>
  </div>
  </div>
  </div>  
  </div>
 <!--文章列表-->
 <div class="Ads_list">
    <div class="border clearfix">
       <span class="l_f">
        <a href="article_add.html"  title="添加文章" id="add_page" class="btn btn-warning"><i class="fa fa-plus"></i> 添加文章</a>
        <a href="#" onclick="batchDel()" class="btn btn-danger"><i class="fa fa-trash"></i> 批量删除</a>
       </span>
       <span class="r_f">共：<b id="labelTotal">45</b>篇文章</span>
     </div>
     <div class="article_list">
         搜索：<input type="text" id="searchtxt" onblur="initPage(1)" placeholder="查询标题"/>
         &nbsp&nbsp&nbsp按时间搜索：<input type="text" id="searchTime" onblur="initPage(1)" placeholder="如:2019-01-01 12:34:56"/>
         <table class="table table-striped table-bordered table-hover" id="sample-table">
       <thead>
		 <tr>
				<th width="25"><label><input type="checkbox" id="chooseAll" class="ace"><span class="lbl"></span></label></th>
				<th width="80px">ID</th>
             <th width="100px">发布用户</th>
             <th width="120">封面图</th>
                <!--<th  width="80px">排序</th>-->
                 <th width="220px">标题</th>
                 <th width="">所属分类</th>
				<th width="150px">添加时间</th>
             <th width="150px">更新时间</th>
                <th width="80px">状态</th>                
				<th width="150px">操作</th>
			</tr>
		</thead>
        <tbody id="articleTable">
         <tr>
          <td><label><input type="checkbox" class="ace"><span class="lbl"></span></label></td>
          <td>12</td>
          <!--<td>2</td>-->
          <td>帮助中心</td>
          <td> 订单已提交成功，如何付款？</td>
          <td class="displayPart" displayLength="60">付款方式分为以下几种：（注：先款订单请您在订单提交后24小时内完成支付， 否则订单会自动取消）</td>
          <td>2016-7-25 12:34</td>
             <td>2016-7-25 12:34</td>
          <td>显示</td>
          <td class="td-manage">   
           <a title="编辑" onclick="member_edit('编辑','member-add.html','4','','510')" href="javascript:;"  class="btn btn-xs btn-info" ><i class="fa fa-edit bigger-120"></i></a>
           <a title="删除" href="javascript:;"  onclick="member_del(this,'1')" class="btn btn-xs btn-danger" ><i class="fa fa-trash  bigger-120"></i></a>
          </td>
         </tr>
        </tbody>
           <tfoot>
           <tr >
               <td colspan="7" align="center">
                   <ul class="pagination" id="splitPage">
                       <li class="disabled"><a href="#">上一页</a></li>
                       <li class="active"><a href="#">1 <span class="sr-only">(current)</span></a></li>
                       <li><a href="#">2</a></li>
                       <li><a href="#">3</a></li>
                       <li><a href="#">4</a></li>
                       <li><a href="#">5</a></li>
                       <li><a href="#">下一页</a></li>
                   </ul>
               </td>
           </tr>
           </tfoot>
       </table>    
     </div>
 </div>
 </div>
</div>
</body>
</html>
<script>
// $(function () {
//         $(".displayPart").displayPart();
//    });
//  //面包屑返回值
// var index = parent.layer.getFrameIndex(window.name);
// parent.layer.iframeAuto(index);
// $('#add_page').on('click', function(){
// 	var cname = $(this).attr("title");
// 	var chref = $(this).attr("href");
// 	var cnames = parent.$('.Current_page').html();
// 	var herf = parent.$("#iframe").attr("src");
//     parent.$('#parentIframe').html(cname);
//     parent.$('#iframe').attr("src",chref).ready();
// 	parent.$('#parentIframe').css("display","inline-block");
// 	parent.$('.Current_page').attr({"name":herf,"href":"javascript:void(0)"}).css({"color":"#4c8fbd","cursor":"pointer"});
// 	//parent.$('.Current_page').html("<a href='javascript:void(0)' name="+herf+" class='iframeurl'>" + cnames + "</a>");
//     parent.layer.close(index);
//
// });
// $(function() {
// 		var oTable1 = $('#sample-table').dataTable( {
// 		"aaSorting": [[ 1, "desc" ]],//默认第几个排序
// 		"bStateSave": true,//状态保存
// 		"aoColumnDefs": [
// 		  //{"bVisible": false, "aTargets": [ 3 ]} //控制列的隐藏显示
// 		  {"orderable":false,"aTargets":[0,2,3,4,5,7,]}// 制定列不参与排序
// 		] } );
// 				$('table th input:checkbox').on('click' , function(){
// 					var that = this;
// 					$(this).closest('table').find('tr > td:first-child input:checkbox')
// 					.each(function(){
// 						this.checked = that.checked;
// 						$(this).closest('tr').toggleClass('selected');
// 					});
//
// 				});
// })

 $(function() { 
	$("#article_style").fix({
		float : 'left',
		//minStatue : true,
		skin : 'green',	
		durationTime :false,
		stylewidth:'220',
		spacingw:30,//设置隐藏时的距离
	    spacingh:250,//设置显示时间距
		set_scrollsidebar:'.Ads_style',
		table_menu:'.Ads_list'
	});
});
//初始化宽度、高度  
 $(".widget-box").height($(window).height()); 
 $(".Ads_list").width($(window).width()-220);
  //当文档窗口发生改变时 触发  
    $(window).resize(function(){
	$(".widget-box").height($(window).height());
	 $(".Ads_list").width($(window).width()-220);
});

/*文章-删除*/
function member_del(obj,id){
    var str;
	layer.confirm('确认要删除吗？',{icon:0,},function(index){

        $.ajax({
            type:'POST',
            url:'updateArticleByPrimaryKeySelective',
            contentType:"application/json; charset=utf-8",
            data:JSON.stringify({
                "articleId":id,
                "status":0
            }),
            success:function (response) {

                if(response==true) {
                    str="已删除！";
                }else {
                    str="删除失败！"
                }
            },
            error:function (response) {
                console.log(response);
                str="删除失败！"
            },
            dataType:'json'

        });

		$(obj).parents("tr").remove();
		layer.msg(str,{icon:1,time:1000});
	});
}

</script>
<script>
    /**获取总篇数**/
    function getCount(id) {
        var num;
        $.ajax({
            type:'POST',
            url:'getCountByLabelId',
            contentType:"application/json; charset=utf-8",
            data:JSON.stringify({
                "labelId":id
            }),
            async:false,
            success:function (response) {

                num = response;
            },
            error:function (response) {
                console.log(response);
            },
            dataType:'json'
        });
        return num;
    }
    /**写入总篇数**/
    function initCount(id) {
        var labelTotal = document.getElementById("labelTotal");
        labelTotal.innerHTML=getCount(id);
    }
    initCount(0);

    /**初始化分类列表**/
    $.get("getLabelList").done(function (data) {
        $(data).each(function (index, item) {
            $("#labelList").append("<li><i class=\"fa fa-newspaper-o pink \"></i> <a href=\"#\" onclick='searchByLabel("+item.labelId+",\""+item.labelName+"\")' >"+item.labelName+"("+getCount(item.labelId)+")</a></li>");
        })
    });
    /**按分类搜索**/
    function searchByLabel(id,labelName) {
        initCount(id);
        initPage(1,labelName);
    }

    /**初始化数据表格**/
    function initPage(currentPage,labelName) {
        var searchtxt = document.getElementById("searchtxt").value;
        var searchTime = document.getElementById("searchTime").value;
        $.ajax({
            type:'POST',
            url:'initArticlePage',
            contentType:"application/json; charset=utf-8",
            data:JSON.stringify({
                "labelName":labelName,
                "articleTitle": searchtxt,
                "createTime": searchTime,
                "page": {
                    "currentPage": currentPage,
                    "pageSize": 99
                }

            }),
            success:function (response) {

                $("#articleTable").empty();
                $(response.articleDtoList).each(function (index, item) {
                    $("#articleTable").append($("<tr>\n" +
                        "          <td><label><input type=\"checkbox\" class=\"ace ids\" value='"+item.article_id+"' onclick='chooseOne(this)'><span class=\"lbl\"></span></label></td>\n" +
                        "          <td>"+item.article_id+"</td>\n" +
                        "          <td>"+item.user_name+"</td>\n" +
                        (item.article_pic == null?"<td><button onclick='upload_article_pic("+item.article_id+")'>上传封面</button></td>":"<td><a href='#'><img src=\"images/cover/"+item.article_pic+"\" style=\"width: 120px;height: 90px;\" align=\"middle\" onclick='upload_article_pic("+item.article_id+")'/></a></td>") +
                        "          <td>"+item.article_title+"</td>\n" +
                        "          <td>"+item.label_name+"</td>\n" +
                        "          <td>"+item.create_time+"</td>\n" +
                        "          <td>"+item.update_time+"</td>\n" +
                        "          <td>启用</td>\n" +
                        "          <td class=\"td-manage\">   \n" +
                        "           <a title=\"编辑\" onclick=\"location.href='article_edit.html?article_id="+item.article_id+"'\" href=\"javascript:;\"  class=\"btn btn-xs btn-info\" ><i class=\"fa fa-edit bigger-120\"></i></a>\n" +
                        "           <a title=\"删除\" href=\"javascript:;\"  onclick=\"member_del(this,"+item.article_id+")\" class=\"btn btn-xs btn-danger\" ><i class=\"fa fa-trash  bigger-120\"></i></a>\n" +
                        "          </td>\n" +
                        "         </tr>"));
                });
                var page = response.page;
                var str ="";
                $("#splitPage").empty();
                if(page.currentPage==1){
                    str = "<li class=\"disabled\"><a href=\"#\" onclick='initPage("+(page.currentPage-1)+")'>上一页</a></li>";
                }else{
                    str = "<li><a href=\"#\" onclick='initPage("+(page.currentPage-1)+")'>上一页</a></li>";
                }
                for(var i=1;i<=page.pageCount;i++){
                    if(i==page.currentPage){
                        str += "<li class=\"active\"><a href=\"#\" onclick='initPage("+i+")'>"+i+"</a></li>"
                    }else {
                        str += "<li><a href=\"#\" onclick='initPage("+i+")'>"+i+"</a></li>"

                    }
                }
                if(page.currentPage==page.pageCount){
                    str += "<li class=\"disabled\"><a href=\"#\" onclick='initPage("+(page.currentPage+1)+")'>下一页</a></li>";
                }else{
                    str += "<li><a href=\"#\" onclick='initPage("+(page.currentPage+1)+")'>下一页</a></li>";
                }
                $("#splitPage").html(str);
            },
            error:function (response) {
                console.log(response)
            },
            dataType:'json'
        })
    }
    initPage(1,null);

    /**批量删除**/
    var chooseNum = 0;
    $("#chooseAll").click(function () {
        var flag = $(this).prop("checked");
        $(".ids").each(function () {
            $(this).prop("checked",flag);
        });
        if(flag) {
            chooseNum=$(".ids").length;
        }else {
            chooseNum=0;
        }
    });
    function chooseOne(obj) {
        var flag = $(obj).prop("checked");
        if (flag) {
            chooseNum++;
            if (chooseNum == $(".ids").length) {
                $("#chooseAll").prop("checked", true);
            }
        } else {
            chooseNum--;
            $("#chooseAll").prop("checked", false);
        }

    }

    function batchDel() {

        var str = 0;

        layer.confirm('确认要删除吗？',{icon:0,},function(index){

            var ids = new Array();
            $(".ids:checked").each(function () {
                ids.push($(this).val().trim());
                var articleId = $(this).val().trim();
                $.ajax({
                    type:'POST',
                    url:'updateArticleByPrimaryKeySelective',
                    contentType:"application/json; charset=utf-8",
                    data:JSON.stringify({
                        "articleId":articleId,
                        "status":0
                    }),
                    success:function (response) {

                        if(response==true) {
                            str++;
                        }
                    },
                    error:function (response) {
                        console.log(response);
                        alert("删除失败！");
                    },
                    dataType:'json'

                });
            });
            var msg = "";
            if(str == ids.length) {
                msg = "删除成功！";
            }else {
                msg = "删除失败！"
            }
            initPage(1);
            layer.msg("删除成功！",{icon:1,time:1000});
        });
    }

    /**上传图片**/
    function upload_article_pic(articleId) {
        var html = "<div style='margin-left: 50px'><form id='uploadForm' name=\"formUpload\" action=\"/back_platform/fileUpload\" method=\"post\" enctype=\"multipart/form-data\">\n" +
            "<label>封面图片</label><input type='hidden' name='articleId' value='"+articleId+"'/>\n" +
            "<input name=\"uploadFile\" type=\"file\" id='uploadPic'/><br/>\n" +
            "<img id=\"article_pic\"/><br/>\n" +
            "</form></div>";
        layer.open({
            type: 1,
            title: '编辑文章封面',
            maxmin: true,
            shadeClose: true, //点击遮罩关闭层
            area : ['600px' , ''],
            content:html,
            btn:['提交','取消'],
            yes:function(index,layero){

                $("#uploadForm").submit();

                layer.alert("修改完成",{
                    title: '提示框',
                    icon:1,
                });
                layer.close(index);

            }
        })
    }

    $("#uploadPic").change(function () {
        //获取上传的图片
        var fileObj = this.files[0];
        //把图片对象转换成url
        var fileUrl = window.URL.createObjectURL(fileObj);
        //改变图片的src属性
        $("#article_pic").attr("src",fileUrl);
    })
</script>